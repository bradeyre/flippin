// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USERS
// ============================================

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  phone             String?  @unique

  // Profile
  firstName         String?
  lastName          String?
  avatar            String?

  // Type
  type              UserType @default(PERSONAL_SELLER)

  // Verification
  verified          Boolean  @default(false)
  verificationLevel VerificationLevel @default(BASIC)
  idDocumentUrl     String?

  // Business (if applicable)
  companyName       String?
  cipcNumber        String?

  // Location
  province          Province?
  city              String?

  // Banking details
  bankName          String?
  accountHolder     String?
  accountNumber     String?
  branchCode        String?
  accountType       String?
  bankingVerified   Boolean  @default(false)

  // Stats
  rating            Decimal? @default(0) @db.Decimal(3,2)
  totalSales        Int      @default(0)
  totalPurchases    Int      @default(0)

  // Preferences
  notificationPrefs Json?

  // Relationships
  listings          Listing[]
  buyOrders         BuyOrder[]
  offers            Offer[]
  sentMessages      Message[] @relation("SentMessages")
  receivedMessages  Message[] @relation("ReceivedMessages")
  sellerTransactions Transaction[] @relation("SellerTransactions")
  buyerTransactions  Transaction[] @relation("BuyerTransactions")
  reviews           Review[]
  notifications     Notification[]
  instantBuyer      InstantBuyer?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([email])
  @@index([phone])
}

enum UserType {
  PERSONAL_SELLER
  PERSONAL_BUYER
  BUSINESS_SELLER
  BUSINESS_BUYER
  INSTANT_BUYER
  ADMIN
}

enum VerificationLevel {
  BASIC
  VERIFIED
  PREMIUM
  BUSINESS
}

enum Province {
  GAUTENG
  WESTERN_CAPE
  KWAZULU_NATAL
  EASTERN_CAPE
  FREE_STATE
  LIMPOPO
  MPUMALANGA
  NORTH_WEST
  NORTHERN_CAPE
}

// ============================================
// CATEGORIES
// ============================================

model Category {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  icon        String?

  // Hierarchy
  parentId    String?
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children    Category[] @relation("CategoryTree")

  // AI metadata
  typicalPriceRange Json?
  keyAttributes     String[]
  qualifyingQuestions Json? // Category-specific questions to ask sellers

  listings    Listing[]
  buyOrders   BuyOrder[]

  createdAt   DateTime   @default(now())

  @@index([slug])
  @@index([parentId])
}

// ============================================
// LISTINGS
// ============================================

model Listing {
  id                String      @id @default(cuid())

  // Seller
  sellerId          String
  seller            User        @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  // Status
  status            ListingStatus @default(DRAFT)

  // Item
  title             String
  description       String      @db.Text
  categoryId        String
  category          Category    @relation(fields: [categoryId], references: [id])
  condition         Condition

  // Product details (seller confirmed)
  brand             String?
  model             String?
  variant           String?
  detailedSpecs     Json?       // Battery health, IMEI, etc.
  sellerConfirmed   Boolean     @default(false)

  // Pricing
  askingPrice       Decimal     @db.Decimal(10,2)
  shippingCost      Decimal?    @db.Decimal(10,2)

  // AI data
  aiAnalysis        Json?
  aiSuggestedPrice  Decimal?    @db.Decimal(10,2)
  aiConfidence      String?
  qualityScore      Int?

  // Media
  images            String[]

  // Location
  province          Province
  city              String

  // Delivery
  deliveryMethods   DeliveryMethod[]

  // Distribution options
  onMarketplace     Boolean     @default(true)
  sentToBuyerNetwork Boolean    @default(false)

  // Engagement
  views             Int         @default(0)
  saves             Int         @default(0)

  // Relationships
  offers            Offer[]
  instantOffers     InstantOffer[]
  messages          Message[]
  transactions      Transaction[]
  matchedBuyOrders  BuyOrder[]

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  expiresAt         DateTime?
  soldAt            DateTime?

  @@index([sellerId, status])
  @@index([categoryId, status])
  @@index([status, createdAt])
  @@index([province, categoryId])
  @@index([onMarketplace, status])
}

enum ListingStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  SOLD
  EXPIRED
  REMOVED
}

enum Condition {
  NEW
  LIKE_NEW
  GOOD
  FAIR
  POOR
}

enum DeliveryMethod {
  PAXI
  DOOR_TO_DOOR
}

// ============================================
// BUY ORDERS (Stock Exchange Model)
// ============================================

model BuyOrder {
  id                String         @id @default(cuid())

  // Buyer
  buyerId           String
  buyer             User           @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  // Status
  status            BuyOrderStatus @default(ACTIVE)

  // What they want
  title             String
  description       String         @db.Text
  categoryId        String
  category          Category       @relation(fields: [categoryId], references: [id])

  // Acceptable conditions
  conditions        Condition[]

  // Pricing
  offerPrice        Decimal        @db.Decimal(10,2)

  // Payment
  cardAuthorized    Boolean        @default(false)
  authReference     String?

  // Location
  provinces         Province[]

  // Matched listing
  matchedListings   Listing[]

  views             Int            @default(0)

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  expiresAt         DateTime
  fulfilledAt       DateTime?

  @@index([buyerId, status])
  @@index([categoryId, status])
  @@index([status, createdAt])
}

enum BuyOrderStatus {
  ACTIVE
  MATCHED
  EXPIRED
  CANCELLED
}

// ============================================
// INSTANT BUYERS
// ============================================

model InstantBuyer {
  id              String  @id @default(cuid())
  userId          String  @unique
  user            User    @relation(fields: [userId], references: [id])

  companyName     String
  approved        Boolean @default(false)

  // Categories they buy
  categories      String[] // category IDs

  // Pricing rules
  baseOffer       Decimal  @db.Decimal(5,2) // e.g., 0.60 = 60%
  conditionRules  Json     // { NEW: 1.10, LIKE_NEW: 1.05, GOOD: 1.0, FAIR: 0.85, POOR: 0.70 }

  // Status
  active          Boolean  @default(true)
  pausedAt        DateTime?
  pausedReason    String?

  // Stats
  totalPurchases  Int      @default(0)
  totalSpent      Decimal  @default(0) @db.Decimal(12,2)

  offers          InstantOffer[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([active, approved])
}

// ============================================
// INSTANT OFFERS
// ============================================

model InstantOffer {
  id              String       @id @default(cuid())

  listingId       String
  listing         Listing      @relation(fields: [listingId], references: [id], onDelete: Cascade)

  buyerId         String
  buyer           InstantBuyer @relation(fields: [buyerId], references: [id])

  sellerReceives  Decimal      @db.Decimal(10,2) // What seller gets
  buyerPays       Decimal      @db.Decimal(10,2) // Includes 5% platform fee
  platformFee     Decimal      @db.Decimal(10,2) // 5% commission

  status          OfferStatus  @default(PENDING)

  createdAt       DateTime     @default(now())
  expiresAt       DateTime
  acceptedAt      DateTime?

  @@index([listingId, status])
  @@index([buyerId, status])
}

// ============================================
// OFFERS (Regular marketplace offers)
// ============================================

model Offer {
  id          String      @id @default(cuid())

  listingId   String
  listing     Listing     @relation(fields: [listingId], references: [id], onDelete: Cascade)

  buyerId     String
  buyer       User        @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  amount      Decimal     @db.Decimal(10,2)
  message     String?     @db.Text

  status      OfferStatus @default(PENDING)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  expiresAt   DateTime
  respondedAt DateTime?

  @@index([listingId, status])
  @@index([buyerId])
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  WITHDRAWN
}

// ============================================
// TRANSACTIONS
// ============================================

model Transaction {
  id              String           @id @default(cuid())

  sellerId        String
  seller          User             @relation("SellerTransactions", fields: [sellerId], references: [id])

  buyerId         String
  buyer           User             @relation("BuyerTransactions", fields: [buyerId], references: [id])

  listingId       String
  listing         Listing          @relation(fields: [listingId], references: [id])

  // Amounts
  itemPrice       Decimal          @db.Decimal(10,2)
  shippingCost    Decimal          @db.Decimal(10,2) @default(0)
  totalAmount     Decimal          @db.Decimal(10,2) // What buyer pays
  platformFee     Decimal          @db.Decimal(10,2)
  sellerReceives  Decimal          @db.Decimal(10,2)

  // Type
  transactionType TransactionType

  // Payment
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus    @default(PENDING)
  paymentProof    String?          // URL to uploaded proof of payment
  paymentRef      String?          // Bank reference

  // Delivery
  deliveryMethod  DeliveryMethod?
  trackingNumber  String?
  courierName     String?
  deliveryStatus  DeliveryStatus   @default(PENDING)

  // Status
  status          TransactionStatus @default(CREATED)

  // Dispute & Review
  disputeReason   String?
  disputedAt      DateTime?
  review          Review?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  paidAt          DateTime?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  completedAt     DateTime?

  @@index([sellerId])
  @@index([buyerId])
  @@index([listingId])
  @@index([status])
  @@index([paymentStatus])
}

enum TransactionType {
  MARKETPLACE
  INSTANT_OFFER
  BUY_ORDER
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PROOF_UPLOADED
  VERIFIED
  HELD_ESCROW
  RELEASED_TO_SELLER
  REFUNDED
}

enum DeliveryStatus {
  PENDING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum TransactionStatus {
  CREATED
  PAYMENT_PENDING
  PAID
  SHIPPED
  DELIVERED
  INSPECTION_PERIOD
  COMPLETED
  DISPUTED
  CANCELLED
  REFUNDED
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id                String      @id @default(cuid())

  transactionId     String      @unique
  transaction       Transaction @relation(fields: [transactionId], references: [id])

  reviewerId        String
  reviewer          User        @relation(fields: [reviewerId], references: [id])

  revieweeId        String      // The user being reviewed

  rating            Int         // 1-5
  comment           String?     @db.Text

  // Detailed ratings
  communicationRating Int?
  accuracyRating     Int?
  shippingRating     Int?

  createdAt         DateTime    @default(now())

  @@index([reviewerId])
  @@index([revieweeId])
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id          String   @id @default(cuid())

  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId  String
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  listingId   String?
  listing     Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  content     String   @db.Text
  attachments String[]

  read        Boolean  @default(false)
  readAt      DateTime?

  createdAt   DateTime @default(now())

  @@index([senderId, receiverId])
  @@index([listingId])
  @@index([receiverId, read])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(cuid())

  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String
  message   String           @db.Text
  data      Json?
  actionUrl String?

  channels  String[]         // email, sms, push

  read      Boolean          @default(false)
  readAt    DateTime?

  createdAt DateTime         @default(now())

  @@index([userId, read])
  @@index([createdAt])
}

enum NotificationType {
  BUY_ORDER_MATCHED
  INSTANT_OFFER_RECEIVED
  OFFER_RECEIVED
  OFFER_ACCEPTED
  PAYMENT_CONFIRMED
  ITEM_SHIPPED
  ITEM_DELIVERED
  ITEM_SOLD
  PAYMENT_RELEASED
  VERIFICATION_COMPLETE
  MESSAGE_RECEIVED
  REVIEW_RECEIVED
  LISTING_APPROVED
  LISTING_REJECTED
}

// ============================================
// PLATFORM SETTINGS
// ============================================

model PlatformSettings {
  id    String @id @default("settings")

  // Commission rates
  marketplaceRate      Decimal @db.Decimal(5,2) @default(0.055) // 5.5%
  freeThreshold        Decimal @db.Decimal(10,2) @default(1000) // R1000
  instantOfferRate     Decimal @db.Decimal(5,2) @default(0.05)  // 5%

  // Escrow
  escrowReleaseDays    Int     @default(2) // days after delivery

  // Messaging templates
  emailTemplates       Json?
  smsTemplates         Json?

  // Platform bank details
  platformBankName     String?
  platformAccountName  String?
  platformAccountNumber String?
  platformBranchCode   String?

  updatedAt DateTime @updatedAt
}

// ============================================
// LEDGER (Audit Trail)
// ============================================

model LedgerEntry {
  id              String      @id @default(cuid())

  transactionId   String?

  type            LedgerEntryType
  description     String

  // Amounts
  amount          Decimal     @db.Decimal(10,2)

  // Parties
  fromUserId      String?
  toUserId        String?

  // Platform revenue
  platformRevenue Decimal?    @db.Decimal(10,2)

  // Status
  status          LedgerStatus @default(PENDING)

  // Payment details
  paymentMethod   String?
  paymentRef      String?

  // Metadata
  metadata        Json?

  createdAt       DateTime    @default(now())
  completedAt     DateTime?

  @@index([transactionId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
  @@index([createdAt])
}

enum LedgerEntryType {
  BUYER_PAYMENT
  SELLER_PAYOUT
  PLATFORM_FEE
  REFUND
  SHIPPING_REIMBURSEMENT
}

enum LedgerStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}
